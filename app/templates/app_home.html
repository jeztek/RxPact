{% extends "base.html" %}

{% block head %}

<style>

#header {
//  text-align: left;
  margin-left: 6px;
  margin-top: 30px;
  font-size: 1em;
//  margin: 0px auto;
}

.pane {
  color: #000;
}

.left-pane {
  width: 500px;
  margin-left: 5px;
  float: left;  
}

.right-pane {
  width: 500px;
  margin-right: 5px;
  float: right;
}

.medication {
  margin-bottom: 20px;
}

.medication .you_relative_time {
  font-size: 3em;
}

.medication .you_absolute_time {
  font-size: 2em;
  color: #555;
  margin-bottom: 10px;
}

.medication .you_med {
  padding-left: 20px;
  font-size: 1em;
}

.medication .you_med div {
  display: inline-block;
  padding-right: 20px;
  padding-bottom: 10px;
  text-align: center;
}

.medication .you_med div img {
  vertical-align: middle;
}

.past {
  color: #F00;
}

.med_image {
  max-width: 100px;
  max-height: 100px;
}


.button {
  //vertical-align: middle;
  -moz-box-shadow:inset 0px 1px 0px 0px #caefab;
  -webkit-box-shadow:inset 0px 1px 0px 0px #caefab;
  box-shadow:inset 0px 1px 0px 0px #caefab;
  background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #77d42a), color-stop(1, #5cb811) );
  background:-moz-linear-gradient( center top, #77d42a 5%, #5cb811 100% );
  filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#77d42a', endColorstr='#5cb811');
  background-color:#77d42a;
  -moz-border-radius:6px;
  -webkit-border-radius:6px;
  border-radius:6px;
  border:1px solid #268a16;
  display:inline-block;
  color:#306108;
  font-family:arial;
  font-size:15px;
  font-weight:bold;
  padding:4px 8px;
  text-decoration:none;
  text-shadow:1px 1px 0px #aade7c;
}.button:active {
  background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #5cb811), color-stop(1, #77d42a) );
  background:-moz-linear-gradient( center top, #5cb811 5%, #77d42a 100% );
  filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#5cb811', endColorstr='#77d42a');
  background-color:#5cb811;
}

.hidden {
  display: none;
}

#msg_send {
  display: none;
  width: 280px;
  height: 160px;
  padding-top: 20px;
  background-color: #63A120;
}

#msg_send #msg_body {
  width: 240px;
  height: 100px;
}

#network_title {
  font-size: 2em;
  margin-bottom: 20px;
}

.network {
  margin-top: 15px;
  display: inline-block;
  padding-right: 0px;
  padding-bottom: 10px;
  text-align: center;
}

.network img {
  max-width: 70px;
  max-height: 70px;
}

.network a {
  font-size: 1em;
  text-decoration: none;
  color: #555;
}

.network a img:hover {
 border-bottom: 6px solid blue !important; 
}

.cats {
  width: 500px;
  height: 320px;  
  background: url(/static/img/cats/cats4.jpg);
}

.bowls {
  margin-left: 30px; 
}

.team {
  margin-left: 20px; 
  margin-top: 10px;
}

.bowl {
  width: 110px;
  height: 80px;
  float: left;
  background-size: 100px auto;
  margin-bottom: 10px;
}

.bowl.full {
  background: url(/static/img/bowls/bowl_full.jpg) no-repeat;  
}

.bowl.empty {
  background: url(/static/img/bowls/bowl_empty.jpg) no-repeat;  
}

.bowl.empty:hover {
  background: url(/static/img/bowls/bowl_empty_blue.jpg) no-repeat;
  cursor: pointer;
}

.bowl.red, .bowl.red:hover {
  background: url(/static/img/bowls/bowl_red.jpg) no-repeat; 
  cursor: pointer;
}

.clearer {
  clear: both;

#congrats {
  display: none;
  width: 500px;
  height: 150px;
  padding-top: 20px;
  background-color: #63A120;
}

</style>

<script>

String.repeat = function(chr,count)
{    
    var str = ""; 
    for(var x=0;x<count;x++) {str += chr}; 
    return str;
}

String.prototype.padL = function(width,pad)
{
    if (!width ||width<1)
        return this;   

    if (!pad) pad=" ";
    var length = width - this.length
    if (length < 1) return this.substr(0,width);

    return (String.repeat(pad,length) + this).substr(0,width);    
}    

String.prototype.padR = function(width,pad)
{
    if (!width || width<1)
        return this;        

    if (!pad) pad=" ";
    var length = width - this.length
    if (length < 1) this.substr(0,width);

    return (this + String.repeat(pad,length)).substr(0,width);
} 

Date.prototype.formatDate = function(format)
{
    var date=this;

    if (!format)
      format="MM/dd/yyyy";               
 
    var month = date.getMonth() + 1;
    var year = date.getFullYear();    
 
    format = format.replace("MM",month.toString().padL(2,"0"));        
 
    if (format.indexOf("yyyy") > -1)
        format = format.replace("yyyy",year.toString());
    else if (format.indexOf("yy") > -1)
        format = format.replace("yy",year.toString().substr(2,2));
 
    format = format.replace("dd",date.getDate().toString().padL(2,"0"));
 
    var hours = date.getHours();       
    if (format.indexOf("t") > -1)
    {
       if (hours > 11)
        format = format.replace("t","PM")
       else
        format = format.replace("t","AM")
    }
    if (format.indexOf("HH") > -1)
        format = format.replace("HH",hours.toString());
    if (format.indexOf("hh") > -1) {
        if (hours > 12) hours - 12;
        if (hours == 0) hours = 12;
        format = format.replace("hh",hours.toString().padL(2,"0"));
    }
    if (format.indexOf("mm") > -1)
       format = format.replace("mm",date.getMinutes().toString().padL(2,"0"));
    if (format.indexOf("ss") > -1)
       format = format.replace("ss",date.getSeconds().toString().padL(2,"0"));
    return format;
}

// it's always between 7 and 8 here
var current_time = new Date();
var current_slot = 0;
current_time.setHours(7);
current_time.setMinutes(59);
var schedule = {{ schedule_json|safe }};

function set_times() {
  var relative_time_slot;
  var i, len;

  for (i=0; len = schedule.length, i < len; i+=1) {
    slot = schedule[i];
    relative_time_slot = $("#time_slot_" + i).find(".you_relative_time");
    minutes_away = Math.ceil((new Date(slot.timestamp) - current_time) / 60000);
    if (minutes_away == 0) {
        $("#action_" + i).removeClass("hidden");
        // tell the cat side that user 0 needs to start taking meds
        // meds_start(0);
    }
    if (minutes_away < 0) {
      relative_time_slot.addClass("past");
      relative_time_slot.html(-minutes_away + " minutes ago");
    } 
    else {
      relative_time_slot.removeClass("past");
      if (minutes_away < 60) {
        relative_time_slot.html("in " + minutes_away + " minutes"); 
      }
    }
  }
  $("#current_time").html(current_time.formatDate("HH:mm t"));
}

function set_current() {
  var t = prompt("Enter time, e.g. 10:38 or 15:05");
  var parts = t.split(":");
  current_time.setHours(parts[0]);
  current_time.setMinutes(parts[1]);
  set_times();
}

function meds_success(id) {
  $(".network#network_"+id+" .bowl").removeClass("empty").addClass("full");
  EvalSound("pour_food");
  add_cat();
}

function EvalSound(soundobj) {
  var thissound=document.getElementById(soundobj);
  thissound.Play();
}

function add_cat() {
  var curr_num_cats = parseInt($(".cats").attr("data-num-cats"));
  $(".cats").attr("data-num-cats", curr_num_cats + 1);
  var new_num_cats = $(".cats").attr("data-num-cats");
  $(".cats").css('backgroundImage','url(/static/img/cats/cats' + new_num_cats + '.jpg)');
}


jQuery(function() {

  var RXPACT = RXPACT || {};

  RXPACT.sendSms = function() {
    $.post("/sms/", {
      "id" : id,
      "msg" : $("#msg_send #msg_body").html()
    }, function(data) {
      alert($("#msg_send #msg_body").html());
    });
  };			 

  $("#title").corner("bl br 5px");
  $("img").corner("8px");

  $(".button").click(function() {
    current_slot = this.id.split("_")[1];
    var time_slot = $("#time_slot_" + current_slot);
    $.post("/done/", { "id" : 0 }, 
      function(data) {
        //time_slot.css("display", "none");
        $("#congrats").lightbox_me({
          centered: true,
          onLoad: function() {
            $("#congrats").corner("8px");
        }
    });
      }
    );
  });

  $(".team a").click(function(e) {
    var id = this.id.split("_")[2];
    $("#msg_send").lightbox_me({
      centered: true,
      onLoad: function() {
        $("#msg_send").corner("8px");
      }
    });
  });

  $("#congrats_done").click(function(e) {
    $("#congrats").trigger("close");
    $("#time_slot_" + current_slot).css("display", "none");
    // tell the cat side that user 0 succeeded in taking their meds
    meds_success({{ user.id }});
  });

  // set relative times
  set_times();

  // advance current time on a timer
  window.setInterval(function() {  
    current_time.setTime(current_time.getTime() + 10000);
    set_times();
  }, 10000);

  // Flash Bowl Red if Cat Hungry
  window.setInterval(function() {  
    $(".bowl.hungry").toggleClass("red");    
  }, 300);
  
});

</script>

<!-- Preload Sound Files -->
<embed src="/static/sounds/pour_food.wav" autostart=false width=1 height=1 id="pour_food" enablejavascript="true">
<embed src="/static/sounds/meow_hungry.wav" autostart=false width=1 height=1 id="meow_hungry" enablejavascript="true">
<!-- <span onClick="EvalSound('sound1')">pour</span> -->

{% endblock head %}

{% block body %}

<div id="header">
It is currently <span id="current_time"></span>. <a href="javascript:set_current();" style="opacity: 0.25;">[set]</a>
</div>

<br style="clear: both" />

<div class="pane left-pane" id="you">
  {% for time_slot in schedule %}
    <div class="medication" id="time_slot_{{ forloop.counter0 }}">  
      <div>
	<div class="you_relative_time"></div>
        <div class="you_absolute_time">{{ time_slot.time }}</div>
      </div>
      <table>
	<tr>
	  <td style="min-width: 50px;">
	    <div id="action_{{ forloop.counter0 }}" class="hidden">
	      <a href="#" class="button" id="button_{{ forloop.counter0 }}">Done</a>
	    </div>
	  </td>
	  <td>
	    <div class="you_med">
            {% for med in time_slot.meds %}
              <div><img class="med_image" src="/static/img/{{ med.picture_name }}" /><br />{{ med.name }}<br />{{ med.dose }}</div>
            {% endfor %}
            </div>
	  </td>
	</tr>
      </table>
    </div>
  {% endfor %}
</div>

<div class="pane right-pane" id="network">

  <div id="network_title">My Cats</div>
  
  <div class="cats" data-num-cats="4"></div>
  

  <!-- <div class="bowls">
    <div class="bowl full"></div>
    <div class="bowl empty"></div>
    <div class="bowl full"></div>
    <div class="bowl empty hungry"></div>    
  </div> -->
 
  <div class="team">
    {% for entry in user_network %}
      <div class="network" id="network_{{ entry.link.id }}">
        <a href="#" id="network_imglink_{{ entry.link.id }}">
        <div class="bowl empty"></div>
        <br/>
        <img src="/static/img/avatars/medium/{{ entry.link.get_profile.picture_name }}" style="border-bottom: 6px solid {{ entry.color }}"/></a>
        <br />
        {{ entry.link.first_name }}
        </a>
      </div>
    {% endfor %}
  </div>  
  
</div>

<br style="clear: both;" />

<div id="msg_send">
  <div id="msg_container">
    <div id="msg_title">Send a cheery message</div>
    <div id="msg_to"></div>
    <form action="#" method="post" onSubmit=RXPACT.sendSms()>
      {% csrf_token %}
      <div>
	<textarea id="msg_body"></textarea>
      </div>

      <span><button type="submit">Send</button>&nbsp;&nbsp;<a href="." style="font-size: 0.8em">Cancel</a></span>
    </form>
  </div>
</div>

<div id="congrats">
  <div id="congrats_container">
    <div>Thank you! Great job, your group is sharing in your success.</div>
  </div>
  <span><button id="congrats_done" type="submit">Done</button></span>
</div>
{% endblock body %}

