{% extends "base.html" %}

{% block head %}

<style>

#header {
//  text-align: left;
  margin-left: 6px;
  margin-top: 30px;
  font-size: 1em;
//  margin: 0px auto;
}

.pane {
  color: #000;
}

.left-pane {
  width: 500px;
  margin-left: 5px;
  float: left;  
}

.right-pane {
  width: 500px;
  margin-right: 5px;
  float: right;
}

.medication {
  margin-bottom: 20px;
}

.medication .you_relative_time {
  font-size: 3em;
}

.medication .you_absolute_time {
  font-size: 2em;
  color: #555;
  margin-bottom: 10px;
}

.medication .you_med {
  padding-left: 20px;
  font-size: 1em;
}

.medication .you_med div {
  display: inline-block;
  padding-right: 20px;
  padding-bottom: 10px;
  text-align: center;
}

.medication .you_med div img {
  vertical-align: middle;
}

.past {
  color: #F00;
}

.med_image {
  max-width: 100px;
  max-height: 100px;
}


.button {
  //vertical-align: middle;
  -moz-box-shadow:inset 0px 1px 0px 0px #caefab;
  -webkit-box-shadow:inset 0px 1px 0px 0px #caefab;
  box-shadow:inset 0px 1px 0px 0px #caefab;
  background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #77d42a), color-stop(1, #5cb811) );
  background:-moz-linear-gradient( center top, #77d42a 5%, #5cb811 100% );
  filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#77d42a', endColorstr='#5cb811');
  background-color:#77d42a;
  -moz-border-radius:6px;
  -webkit-border-radius:6px;
  border-radius:6px;
  border:1px solid #268a16;
  display:inline-block;
  color:#306108;
  font-family:arial;
  font-size:15px;
  font-weight:bold;
  padding:4px 8px;
  text-decoration:none;
  text-shadow:1px 1px 0px #aade7c;
}.button:active {
  background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #5cb811), color-stop(1, #77d42a) );
  background:-moz-linear-gradient( center top, #5cb811 5%, #77d42a 100% );
  filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#5cb811', endColorstr='#77d42a');
  background-color:#5cb811;
}

.hidden {
  display: none;
}

#msg_send {
  display: none;
  width: 280px;
  height: 280px;
  padding-top: 20px;
  background-color: #63A120;
}


#msg_body #post_med_msg_body {
  width: 240px;
  height: 100px;
}

#post_msg_container{
  margin-top: 40px;
}

#network_title {
  font-size: 1.8em;
  margin-bottom: 20px;
  z-index: 10;
  position: absolute;
}

.network {
  margin-top: 15px;
  display: inline-block;
  padding-right: 0px;
  padding-bottom: 10px;
  text-align: center;
}

.network img {
  max-width: 70px;
  max-height: 70px;
}

.network a {
  font-size: 1em;
  text-decoration: none;
  color: #555;
}

.network a img:hover {
 border-bottom: 6px solid blue !important; 
}

.cats {
  width: 500px;
  height: 320px;  
  background: url(/static/img/cats/cats4.jpg);
}

.cats_and_team{
  position: relative;
  top: -30px;
  z-index: 0; 
}

.bowls {
  margin-left: 30px; 
}

.team {
  margin-left: 20px; 
  margin-top: 10px;
}

.bowl {
  width: 110px;
  height: 80px;
  float: left;
  background-size: 100px auto;
  margin-bottom: 10px;
}

.bowl.full {
  background: url(/static/img/bowls/bowl_full.jpg) no-repeat;  
}

.bowl.empty {
  background: url(/static/img/bowls/bowl_empty.jpg) no-repeat;  
}

.bowl.empty:hover {
  background: url(/static/img/bowls/bowl_empty_blue.jpg) no-repeat;
  cursor: pointer;
}

.bowl.red, .bowl.red:hover {
  background: url(/static/img/bowls/bowl_red.jpg) no-repeat; 
  cursor: pointer;
}

.clearer {
  clear: both;
}


#a_new_cat {
 position: absolute;
 font-size: 18px;
 background-color: green;
 color: white;
 text-align: center; 
 padding: 10px;
 -moz-border-radius: 5px;
 border-radius: 5px;
 top: 70px;
 display:inline-block;
 display: none;
 left: 160px;
/* display: none;*/
}


#congrats {
  // display: none;
  width: 500px;
  height: 100px;
  padding-top: 20px;
  background-color: #63A120;
  color: white;
  font-size: 18px;
}


.reset_kitten {
  display: none; position: absolute; height: 400px; width: 400px; left: 50px;
}


#med_info {
  display: none;
  width: 600px;
  height: 600px;
  background-color: white;
  padding: 10px;
}

#med_info_container {
  margin-top: 10px;
  font-size: 0.9em;
  text-align: left;
}

#med_info li {
  margin-bottom: 5px;
}

#congrats img {
  max-width: 70px;
  max-height: 70px;
}

</style>

<script>

String.repeat = function(chr,count)
{    
    var str = ""; 
    for(var x=0;x<count;x++) {str += chr}; 
    return str;
}

String.prototype.padL = function(width,pad)
{
    if (!width ||width<1)
        return this;   

    if (!pad) pad=" ";
    var length = width - this.length
    if (length < 1) return this.substr(0,width);

    return (String.repeat(pad,length) + this).substr(0,width);    
}    

String.prototype.padR = function(width,pad)
{
    if (!width || width<1)
        return this;        

    if (!pad) pad=" ";
    var length = width - this.length
    if (length < 1) this.substr(0,width);

    return (this + String.repeat(pad,length)).substr(0,width);
} 

Date.prototype.formatDate = function(format)
{
    var date=this;

    if (!format)
      format="MM/dd/yyyy";               
 
    var month = date.getMonth() + 1;
    var year = date.getFullYear();    
 
    format = format.replace("MM",month.toString().padL(2,"0"));        
 
    if (format.indexOf("yyyy") > -1)
        format = format.replace("yyyy",year.toString());
    else if (format.indexOf("yy") > -1)
        format = format.replace("yy",year.toString().substr(2,2));
 
    format = format.replace("dd",date.getDate().toString().padL(2,"0"));
 
    var hours = date.getHours();       
    if (format.indexOf("t") > -1)
    {
       if (hours > 11)
        format = format.replace("t","PM")
       else
        format = format.replace("t","AM")
    }
    if (format.indexOf("HH") > -1)
        format = format.replace("HH",hours.toString());
    if (format.indexOf("hh") > -1) {
        if (hours > 12) hours - 12;
        if (hours == 0) hours = 12;
        format = format.replace("hh",hours.toString().padL(2,"0"));
    }
    if (format.indexOf("mm") > -1)
       format = format.replace("mm",date.getMinutes().toString().padL(2,"0"));
    if (format.indexOf("ss") > -1)
       format = format.replace("ss",date.getSeconds().toString().padL(2,"0"));
    return format;
}

// it's always between 7 and 8 here
var current_time = new Date();
var current_slot = 0;
current_time.setHours(7);
current_time.setMinutes(59);
var schedule = {{ schedule_json|safe }};

function set_times() {
  var relative_time_slot;
  var i, len;

  for (i=0; len = schedule.length, i < len; i+=1) {
    slot = schedule[i];
    relative_time_slot = $("#time_slot_" + i).find(".you_relative_time");
    minutes_away = Math.ceil((new Date(slot.timestamp) - current_time) / 60000);
    if ((minutes_away == 0) && ($("#action_" + i).hasClass("hidden"))) {
        $("#action_" + i).removeClass("hidden");
        // tell the cat side that user 0 needs to start taking meds
        meds_fail({{ user.id }});
    }
    if (minutes_away < 0) {
      relative_time_slot.addClass("past");
      relative_time_slot.html(-minutes_away + " minutes ago");
    } 
    else {
      relative_time_slot.removeClass("past");
      if (minutes_away < 60) {
        relative_time_slot.html("in " + minutes_away + " minutes"); 
      }
    }
  }
  $("#current_time").html(current_time.formatDate("HH:mm t"));
}

function set_current() {
  var t = prompt("Enter time, e.g. 10:38 or 15:05");
  var parts = t.split(":");
  current_time.setHours(parts[0]);
  current_time.setMinutes(parts[1]);
  set_times();
}

function set_time_to(h, m) {
  current_time.setHours(h);
  current_time.setMinutes(m);
  set_times();
}
  
var meowInterval; 

function meds_fail(id) {
  EvalSound('meow_hungry');
  meowInterval = setInterval("EvalSound('meow_hungry')",3000);
  $(".network#network_"+id+" .bowl").removeClass("full").addClass("empty").delay(5000).addClass("hungry");
}

function meds_success(id) {
  clearInterval(meowInterval);
  $(".network#network_"+id+" .bowl").removeClass("empty").removeClass("hungry").removeClass("red").addClass("full");
  EvalSound("pour_food");
  add_cat();
}

function EvalSound(soundobj) {
  var thissound=document.getElementById(soundobj);
  thissound.Play();
}

function add_cat() {
  animate_cat();
}

function animate_cat() {
  // $("#a_new_cat").fadeIn();
  $("#cat").show();
  $('#cat').animate({
    opacity: 10,
    // left: '+=50',
    height: '120',
    width: '120',
    top: '140',
    left: '200',
    // margin: '200 0 0 0',
    display: 'block'
  }, 2000, function() {
    // Animation complete.
    $('#cat').css("height","400");
    $('#cat').css("width","400");
    $('#cat').css("opacity","1");
    $('#cat').css("top","0");
    $('#cat').css("left","50"); 

    $('#cat').css("display","none");  
    // $("#a_new_cat").fadeOut();  
    
    var curr_num_cats = parseInt($(".cats").attr("data-num-cats"));
    $(".cats").attr("data-num-cats", curr_num_cats + 1);
    var new_num_cats = $(".cats").attr("data-num-cats");
    $(".cats").css('backgroundImage','url(/static/img/cats/cats' + new_num_cats + '.jpg)');
            
  });
}  

jQuery(function() {

  var RXPACT = RXPACT || {};

  RXPACT.sendSms = function() {
    $.post("/sms/", {
      "id" : id,
      "msg" : $("#msg_send #msg_body").html()
    }, function(data) {
      alert($("#msg_send #msg_body").html());
    });
  };			 

  $("#title").corner("bl br 5px");
  $("img").corner("8px");

  $(".button").click(function() {
    current_slot = this.id.split("_")[1];
    var time_slot = $("#time_slot_" + current_slot);
    $.post("/done/", { "id" : 0 }, 
      function(data) {
        //time_slot.css("display", "none");
        $("#congrats").lightbox_me({
          centered: true,
          onLoad: function() {
            $("#congrats").corner("8px");
        }
    });
      }
    );
  });

  $(".med_image").click(function(e) {
    $.getJSON('http://spl.anzonow.com/query?uri=http%3A//spl-ld.anzonow.com/data/Section1', function(data) {
        $("#med_info_container").html(data.summary);
        $("#med_info").lightbox_me({
          centered: true,
          onLoad: function() {
            $("#med_info").corner("8px");
          }
        });
     });
  });

  $(".team a").click(function(e) {
    var id = this.id.split("_")[2];
    $("#msg_send").lightbox_me({
      centered: true,
      onLoad: function() {
        $("#msg_send").corner("8px");
      }
    });
  });

  $("#congrats_done").click(function(e) {
    $("#congrats").trigger("close");
    $("#time_slot_" + current_slot).css("display", "none");

    // tell the cat side that user 0 succeeded in taking their meds
    meds_success({{ user.id }});

    // now go into the portion where your friends take their meds
    simulate_friends_taking_meds();
  });

  $("#med_info_done").click(function(e) {
    $("#med_info").trigger("close");
  });

  // set relative times
  set_times();

  // advance current time on a timer
  window.setInterval(function() {  
    current_time.setTime(current_time.getTime() + 10000);
    set_times();
  }, 10000);

  // Flash Bowl Red if Cat Hungry
  window.setInterval(function() {  
    $(".bowl.hungry").toggleClass("red");    
  }, 300);


});

function simulate_friends_taking_meds() {

  // chain two timers			
  window.setTimeout(function() {

    meds_fail({{ user_network.2.link.id }});
    window.setTimeout(function() {

      meds_success({{ user_network.2.link.id }});
      set_time_to(11, 55);
      window.setTimeout(function() {

        meds_fail({{ user_network.1.link.id }});
        window.setTimeout(function() {

          meds_success({{ user_network.1.link.id }});
          window.setTimeout(function() {

            set_time_to(17, 43);	  
            simulate_friends_forgetting_meds();
	  
          }, 10000);
        }, 5000);
      }, 10000);
    }, 5000);
  }, 10000);
}

function simulate_friends_forgetting_meds()  {
  meds_fail({{ user_network.3.link.id }});
}



</script>

<!-- Preload Sound Files -->
<embed src="/static/sounds/pour_food.wav" autostart=false width=1 height=1 id="pour_food" enablejavascript="true">
<embed src="/static/sounds/meow_hungry.wav" autostart=false width=1 height=1 id="meow_hungry" enablejavascript="true">

<!-- <span onClick="meds_fail(2)">go</span> -->

<!-- <div id="clickme">
  Click here
</div> -->

{% endblock head %}

{% block body %}

<div id="header">
It is currently <span id="current_time"></span>. <a href="javascript:set_current();" style="opacity: 0.25;">[set]</a>
</div>

<br style="clear: both" />

<div class="pane left-pane" id="you">
  {% for time_slot in schedule %}
    <div class="medication" id="time_slot_{{ forloop.counter0 }}">  
      <div>
	<div class="you_relative_time"></div>
        <div class="you_absolute_time">{{ time_slot.time }}</div>
      </div>
      <table>
	<tr>
	  <td style="min-width: 57px;">
	    <div id="action_{{ forloop.counter0 }}" class="hidden">
	      <a href="#" class="button" id="button_{{ forloop.counter0 }}">Done</a>
	    </div>
	  </td>
	  <td>
	    <div class="you_med">
            {% for med in time_slot.meds %}
              <div><img class="med_image" src="/static/img/{{ med.picture_name }}" /><br />{{ med.name }}<br />{{ med.dose }}</div>
            {% endfor %}
            </div>
	  </td>
	</tr>
      </table>
    </div>
  {% endfor %}
</div>

<div class="pane right-pane" id="network">

  <div id="network_title">How Many Cats Can We Feed Today?</div>
  
  <div class="cats_and_team" style="position: relative;">
    
    <!-- <div id="a_new_cat">Yay! A new cat!</div> -->
    <div id="cat" style="display: none; position: absolute; height: 400px; width: 400px; left: 50px;" >
      <img src="/static/img/cats/kitten.png"/>
    </div>
    
    <div class="cats" data-num-cats="4"></div>

    <!-- <div class="bowls">
      <div class="bowl full"></div>
      <div class="bowl empty"></div>
      <div class="bowl full"></div>
      <div class="bowl empty hungry"></div>    
    </div> -->
 

  <div class="team">
    {% for entry in user_network %}
      <div class="network" id="network_{{ entry.link.id }}">
        <a href="#" id="network_imglink_{{ entry.link.id }}">
        <div class="bowl full"></div>
        <br/>
			<img src="/static/img/avatars/medium/{{ entry.link.get_profile.picture_name }}" style="border-bottom: 6px solid"/></a>
        <br />
        {{ entry.link.first_name }}
        </a>
      </div>
    {% endfor %}
  </div>  
  
</div>

<br style="clear: both;" />

<div id="msg_send">
  <div id="msg_container">
    <div id="msg_title">Send a gentle reminder</div>
    <div id="msg_to"></div>
    <form action="#" method="post" onSubmit=RXPACT.sendSms()>
      {% csrf_token %}
      <div>
	<textarea id="msg_body"></textarea>
      </div>

      <span><button type="submit">Send</button>&nbsp;&nbsp;<a href="#" onClick="$('#msg_send').trigger('close');" style="font-size: 0.8em">Cancel</a></span>
    </form>
  </div>
  <div id = "post_msg_container">
	<div id="post_med_msg_title">Leave a message for after they take their meds</div>
    <div id="post_med_msg_to"></div>
	<form action="#" method="post" onSubmit=RXPACDT.savePostMedMsg()>
		{% csrf_token %}
		<div>
			<textarea id="post_med_msg_body"></textarea>
		</div>
	    <span><button type="submit">Send</button>&nbsp;&nbsp;<a href="$('#msg_send').trigger('close');" style="font-size: 0.8em">Cancel</a></span>
    </form>
  </div>
</div>

<div id="congrats">
  <div id="congrats_container">
	<div id = "congrats_generic">Great! Your friends will enjoy the extra cat</div>
	<div id = "congrats_sender">
		<img src="/static/img/avatars/medium/{{ user_network.2.link.get_profile.picture_name }}" style="border-bottom: 6px solid {{ entry.color }}" />
		left you a message:
	</div>
	<div id = "post_med_reward_msg"> Glad you took your meds, mom. Here's a new pic of JJ. He says, "I can't wait to see you on Friday, Grandma."</div>
	<img src="static/img/post_med/jj.jpg" />	</div>
  </div>
  <span><button id="congrats_done" type="submit">Close</button></span>
</div>

<div id="med_info">
  <img src="http://spl.anzonow.com/images/novartislogosmall.png" />
  <br class="clearer" />
  <div id="med_info_container">

  </div>
  <div><button id="med_info_done" type="submit">Done</button></div>
</div>
{% endblock body %}

